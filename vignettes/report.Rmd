---
title: "DE DAS and DTU analysis"
header-includes: \usepackage{caption}
date: "Today"
output:
  word_document:
    fig_caption: yes
    toc: no
    toc_depth: '4'
  pdf_document:
    fig_caption: yes
    toc: yes
    toc_depth: '4'
  html_document:
    fig_caption: yes
    highlight: textmate
    theme: cerulean
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: no
      smooth_scroll: yes
---

```{r setup, include=FALSE,eval=T}
knitr::opts_chunk$set(echo = F,eval = T,warning = F,message = F)
options(stringsAsFactors = F)
```


```{r}
para <- data.frame(read.csv('result/Parameter summary.csv'))
colnames(para) <- c('Step','Description','Parameter')
data.info <- readr::read_csv('result/data.info.csv')
colnames(data.info)[1] <- 'targets'
DDD.number <- readr::read_csv('result/DE DAS DTU numbers.csv')
DEvsDAS <- readr::read_csv('result/DE vs DAS gene number.csv')
DEvsDTU <- readr::read_csv('result/DE vs DTU transcript number.csv')
load('data/contrast.RData')
load('data/samples.RData')
load('data/samples_new.RData')
load('data/DE_genes.RData')
load('data/DAS_genes.RData')
load('data/DE_trans.RData')
load('data/DTU_trans.RData')
load('data/target_high.RData')
```

## Overview
```{r}
# getwd()
knitr::kable(para,format = "markdown") 
```

Table: Overview of parameters used for the DE, DAS and DTU analysis.

## Experimental design
```{r,results='asis'}
cat('  \nConditions ( n=',length(unique(samples$condition)),'):',paste0(unique(samples$condition),collapse = ', '))
cat('  \nBiological replicate number:',length(unique(samples$brep)))
cat('  \nSequencing replicate number:',length(unique(samples$srep)))
cat('  \nContrast groups for expression comparisons:')
x <- do.call(rbind,strsplit(contrast,'-'))
colnames(x) <- c('Treatment','Control')
knitr::kable(x,format = "markdown") 
```

Table: Contrast groups.

## Expression data generation
```{r,results='asis'}
cat('The',as.character(para$Parameter[para$Description=='tximport method']),
    'method in [tximport](https://bioconductor.org/packages/release/bioc/html/tximport.html) 
    R package (Soneson, Love, and Robinson 2016) was used to generate gene and transcript expression.')

```

## Data pre-processing
### Step 1: Merge sequencing replicates
```{r,results='asis'}
cat('The RNA-seq data has',length(unique(samples$srep)),'sequencing replicates.')
if(length(unique(samples$srep)) > 1){
  cat(ifelse(nrow(samples) > nrow(samples_new),'Sequencing replicates have been merged.',
             'Sequencing replicates are not merged. Please redo the analysis'))
} else {
  cat('No need to merge sequencing replicates.')
}
```

### Step 2: Filter low expression
The cut-offs to filter the transcripts were determined by the mean-variance trend plots (Law et al. 2014).
```{r,results='asis'}
cat('\n- An expressed transcript must have $\\geq$',
    para$Parameter[para$Description=='Sample number for CPM cut-off'],'out of',length(samples_new$condition),
    'samples with CPM $\\geq$',para$Parameter[para$Description=='Low expression CPM cut-off'])
cat('\n- An expressed gene must have at least one expressed transcript.\n')
```

```{r,echo=FALSE, out.width = '100%',fig.cap=('Transcript mean-variance trend')}
if(!file.exists('figure/Transcript mean-variance trend.png')){
  cat('The file "Transcript mean-variance trend.png" is not in the "figure" folder of working directory.')
} else {
knitr::include_graphics("figure/Transcript mean-variance trend.png")
}
```

```{r,echo=FALSE, out.width = '100%',fig.cap=('Gene mean-variance trend')}
if(!file.exists('figure/Gene mean-variance trend.png')){
  cat('The file "figure/Gene mean-variance trend.png" is not in the "figure" folder of working directory of working directory')
} else {
knitr::include_graphics("figure/Gene mean-variance trend.png")
}
```
<hr>
Table: Data information after low expression filters.
```{r,results='asis'}
knitr::kable(data.info,format = "markdown") 
```

### Step 3: PCA plots

#### PCA plot of biological replicates
Use the PCA plot to check batch effects between biological replicates

```{r,echo=FALSE, out.width = '100%',fig.cap=('Transcript level PCA plot of biological replicates')}
if(!file.exists('figure/Transcript PCA Bio-reps.png')){
  cat('The file "Transcript PCA Bio-reps.png" is not in the "figure" folder of working directory.')
} else {
knitr::include_graphics("figure/Transcript PCA Bio-reps.png")
}
```

```{r,echo=FALSE, out.width = '100%',fig.cap=('Gene level PCA plot of biological replicates')}
if(!file.exists('figure/Gene PCA Bio-reps.png')){
  cat('The file "figure/Gene PCA Bio-reps.png" is not in the "figure" folder of working directory.')
} else {
knitr::include_graphics("figure/Gene PCA Bio-reps.png")
}
```

```{r,results='asis'}
if(para$Parameter[para$Description=='Batch effect estimation']=='Yes'){
  cat('#### Estimate batch effects (YES)')
  cat('  \nThe data has batch effects. The',para$Parameter[para$Description=='Batch effect estimation method'],
      'method in [RUVSeq](https://bioconductor.org/packages/release/bioc/html/RUVSeq.html) R package (Risso et al. 2014)
      was used to estimate the transcript and gene level batch effect terms between biological replicates, which were 
      incorporated as an additional factor in the linear regression model for expression change analysis.
      The package also generate read counts where the batch effects were removed from the dataset. To avoid data over-correction, the batch removed
      datasets were only used to make the PCA plots rahter than the downstream expression comparision analysis.')
} else {
  cat('#### Estimate batch effects (NO)')
  cat('  \nThe data has no batch effects')
}
```

```{r,echo=FALSE, out.width = '100%',fig.cap=('Transcript level PCA plot of biological replicates, batch effects were removed')}
if(!file.exists('figure/Transcript PCA batch effect removed Bio-reps.png')){
  cat('The file "figure/Transcript PCA batch effect removed Bio-reps.png" is not in the "figure" folder of working directory.')
} else {
  knitr::include_graphics("figure/Transcript PCA batch effect removed Bio-reps.png")
}
```

```{r,echo=FALSE, out.width = '100%',fig.cap=('Gene level PCA plot of biological replicates, batch effects were removed')}
if(!file.exists('figure/Gene PCA batch effect removed Bio-reps.png')){
  cat('The file "figure/Gene PCA batch effect removed Bio-reps.png" is not in the "figure" folder of working directory.')
} else {
  knitr::include_graphics("figure/Gene PCA batch effect removed Bio-reps.png")
}
```

#### PCA plot of average expression
To visualise the data quality and variance between conditions, the average read counts of biological replicates (batch effects were removed if exist) were used to make the PCA plot.

```{r,echo=FALSE, out.width = '100%',fig.cap=('Transcript level PCA plot of average expression.')}
if(!file.exists('figure/Transcript PCA Average expression.png')){
  cat('The file "figure/Transcript PCA Average expression.png" is not in the "figure" folder of working directory.')
} else {
  knitr::include_graphics("figure/Transcript PCA Average expression.png")
}
```

```{r,echo=FALSE, out.width = '100%',fig.cap=('Gene level PCA plot of average expression.')}
if(!file.exists('figure/Gene PCA Average expression.png')){
  cat('The file "figure/Gene PCA Average expression.png" is not in the "figure" folder of working directory.')
} else {
  knitr::include_graphics("figure/Gene PCA Average expression.png")
}
```

### Step 4: Data normalisation
```{r,results='asis'}
cat('The',para$Parameter[para$Description=='Normalisation method'], 'method (Robinson, McCarthy, and Smyth 2010)
    and [edgeR](https://bioconductor.org/packages/release/bioc/html/edgeR.html)
    R package (Robinson, McCarthy, and Smyth 2010) were used to normalise the transcript and gene level read counts.')

```

```{r,echo=FALSE, out.width = '100%',fig.cap=('Transcript level expression distribution.')}
if(!file.exists('figure/Transcript data distribution.png')){
  cat('The file "figure/Transcript data distribution.png" is not in the "figure" folder of working directory.')
} else {
  knitr::include_graphics("figure/Transcript data distribution.png")
}
```

```{r,echo=FALSE, out.width = '100%',fig.cap=('Gene level expression distribution.')}
if(!file.exists('figure/Gene data distribution.png')){
  cat('The file "figure/Gene data distribution.png" is not in the "figure" folder of working directory.')
} else {
  knitr::include_graphics("figure/Gene data distribution.png")
}
```

## DE DAS and DTU analysis

### DE DAS and DTU definitions
![](https://github.com/wyguo/ThreeDRNAseq/raw/master/vignettes/user_manuals/3D_App_figure/DDD_definition.png)

### DE DAS and DTU summary
```{r,results='asis'}
pval.cut <- para$Parameter[para$Description=="Adjusted p-value cut-off"]
lfc.cut <- para$Parameter[para$Description=="Log2 fold change cut-off"]
deltaPS.cut <- para$Parameter[para$Description=="delta PS cut-off"]
pipeline <- para$Parameter[para$Description=="Pipeline"]
cat('#### Methods  \n')
if(pipeline=='limma'){
  cat('\n- Pipeline: ',pipeline,'for DE and',para$Parameter[para$Description=="AS function"],'for DAS and DTU (Smyth et al. 2013)')
} else {
  cat('\n- Pipeline: ',pipeline,'for DE and',para$Parameter[para$Description=="AS function"],'for DAS and DTU (Robinson, McCarthy, and Smyth 2010)')
}

cat('\n- P-value adjusted method: ',para$Parameter[para$Description=="P-value adjust method"])
cat('\n- Adjusted p-value cut-off: ',pval.cut)
cat('\n- Log2 fold change: ',lfc.cut)
cat('\n- deltaPS: ',deltaPS.cut)
cat('\n- Contrast groups: ',paste(contrast,collapse = ','),'  \n  \n')

cat('#### Results  \n')
cat('##### Individual contrast group:  \n')

cat('\n- DE DAS and DTU numbers  \n')
knitr::kable(DDD.number,format = "markdown")
cat('<br>\n')

cat('\n- DE genes compared with DAS genes  \n')
knitr::kable(DEvsDAS,format = "markdown")
cat('<br>\n')

cat('\n- DE transcripts compared with DTU transcripts  \n')
knitr::kable(DEvsDTU,format = "markdown")
cat('<br>\n')

cat('\n- DE transcripts compared with DTU transcripts  \n')
knitr::kable(DEvsDTU,format = "markdown")

```

<br>
<br>

#### Union set of all contrast groups:
```{r,echo=FALSE, out.width = '100%',fig.cap=('Union set of DE and DAS genes across all contrast groups.')}
if(!file.exists('figure/Union set DE genes vs DAS genes.png')){
  cat('The file "figure/Union set DE genes vs DAS genes.png" is not in the "figure" folder of working directory.')
} else {
  knitr::include_graphics("figure/Union set DE genes vs DAS genes.png")
}
```

```{r,echo=FALSE, out.width = '100%',fig.cap=('Union set of DE and DTU transcripts across all contrast groups.')}
if(!file.exists('figure/Union set DE transcripts vs DTU transcripts.png')){
  cat('The file "figure/Union set DE transcripts vs DTU transcripts.png" is not in the "figure" folder of working directory.')
} else {
  knitr::include_graphics("figure/Union set DE transcripts vs DTU transcripts.png")
}
```

## Heatmap
### DE genes
```{r,echo=FALSE, out.width = '50%',fig.cap=('Heatmap of DE genes'),fig.align='left'}
if(!file.exists('figure/Heatmap DE genes.png')){
  cat('The file "Heatmap DE genes.png" is not in the "figure" folder of working directory.')
} else {
  knitr::include_graphics('figure/Heatmap DE genes.png')
}
```

### DAS genes
```{r,echo=FALSE, out.width = '50%',fig.cap=('Heatmap of DAS genes. The DAS only genes were removed in the plot since they have no significant abundance changes in the contrast groups.'),fig.align='left'}
if(!file.exists('figure/Heatmap DAS genes.png')){
  cat('The file "Heatmap DAS genes.png" is not in the "figure" folder of working directory.')
} else {
  knitr::include_graphics('figure/Heatmap DAS genes.png')
}
```

### DE transcript
```{r,echo=FALSE, out.width = '50%',fig.cap=('Heatmap of DE transcripts.'),fig.align='left'}
if(!file.exists('figure/Heatmap DE transcripts.png')){
  cat('The file "Heatmap DE transcripts.png" is not in the "figure" folder of working directory.')
} else {
  knitr::include_graphics('figure/Heatmap DE transcripts.png')
}
```

### DTU transcripts
```{r,echo=FALSE, out.width = '50%',fig.cap=('Heatmap of DTU transcripts. The DTU only transcripts were removed in the plot since they have no significant abundance changes in the contrast groups.'),fig.align='left'}
if(!file.exists('figure/Heatmap DTU transcripts.png')){
  cat('The file "Heatmap DTU transcripts.png" is not in the "figure" folder of working directory.')
} else {
  knitr::include_graphics('figure/Heatmap DTU transcripts.png')
}
```

## GO annotation

### DE genes
```{r,echo=FALSE, fig.cap=('GO annotation plot of DE genes.'),fig.align='left'}
if(!file.exists('figure/DE genes GO annotation plot.png')){
  cat('The file "DE genes GO annotation plot.png" is not in the "figure" folder of working directory.')
} else {
  knitr::include_graphics('figure/DE genes GO annotation plot.png')
}
```

### DAS genes
```{r,echo=FALSE, fig.cap=('GO annotation plot of DAS genes.'),fig.align='left'}
if(!file.exists('figure/DAS genes GO annotation plot.png')){
  cat('The file "DAS genes GO annotation plot.png" is not in the "figure" folder of working directory.')
} else {
  knitr::include_graphics('figure/DAS genes GO annotation plot.png')
}
```

### R packages used for the analysis
```{r}
x <- rbind(c('Make the shiny app','shiny','https://shiny.rstudio.com/'),
                c('','shinydashboard','https://rstudio.github.io/shinydashboard/'),
                c('','rhandsontable','https://jrowen.github.io/rhandsontable/'),
                c('','shinyFiles','https://cran.r-project.org/web/packages/shinyFiles/index.html'),
                c('Read csv file','readr','https://cran.r-project.org/web/packages/readr/index.html'),
                c('Expression generator','tximport','http://bioconductor.org/packages/release/bioc/html/tximport.html'),
                c('Batch effect estimation','RUVSeq','https://bioconductor.org/packages/release/bioc/html/RUVSeq.html'),
                c('3D analysis','limma','https://bioconductor.org/packages/release/bioc/html/limma.html'),
                c('','edgeR','https://bioconductor.org/packages/release/bioc/html/edgeR.html'),
                c('Heatmap','ComplexHeatmap','https://bioconductor.org/packages/release/bioc/html/ComplexHeatmap.html'),
                c('Cluster of heatmap','fastcluster','https://cran.r-project.org/web/packages/fastcluster/index.html'),
                c('Flow charts','Gmisc','https://cran.r-project.org/web/packages/Gmisc/index.html'),
                c('Euler plots','eulerr','https://cran.r-project.org/web/packages/eulerr/index.html'),
                c('Other plots','ggplot2','https://cran.r-project.org/web/packages/ggplot2/index.html'),
                c('','plotly','https://cran.r-project.org/web/packages/plotly/index.html'),
                c('','gridExtra','https://cran.r-project.org/web/packages/gridExtra/index.html'),
                c('','grid','https://cran.r-project.org/web/packages/grid/index.html')
                )
x <- data.frame(x)
colnames(x) <- c('Usage','Package','Link')
knitr::kable(x,format = "markdown") 
```

Table: The main R packages used in the 3D RNA-seq analysis. If any other R packages are missing from your local PC, please install accordingly. 

## References
Law, C W, Y Chen, W Shi, and G K Smyth. 2014. "voom: Precision weights unlock linear model analysis tools for RNA-seq read counts." Genome Biol 15 (2): R29. doi:10.1186/gb-2014-15-2-r29.

Risso, Davide, John Ngai, Terence P. Speed, and Sandrine Dudoit. 2014. "Normalization of RNA-seq data using factor analysis of control genes or samples." Nature Biotechnology 32 (9): 896–902. doi:10.1038/nbt.2931.

Robinson, Mark D, Davis J McCarthy, and Gordon K Smyth. 2010. "edgeR: a Bioconductor package for differential expression analysis of digital gene expression data." Journal Article. Bioinformatics (Oxford, England) 26 (1): 139–40. doi:10.1093/bioinformatics/btp616.

Robinson, Mark D., and Alicia Oshlack. 2010. "A scaling normalization method for differential expression analysis of RNA-seq data." Genome Biology 11 (3): R25. doi:10.1186/gb-2010-11-3-r25.

Smyth, Gordon K, Matthew Ritchie, Natalie Thorne, James Wettenhall, and Wei Shi. 2013. "limma:Linear Models for Microarray Data User’s Guide(Now Including RNA-Seq Data Analysis)." R Manual, 1–123.

Soneson, Charlotte, Michael I Love, and Mark D Robinson. 2016. "Differential analyses for RNA-seq: transcript-level estimates improve gene-level inferences." Journal Article. F1000Research 4: 1521. doi:10.12688/f1000research.7563.2.



